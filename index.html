<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroNexus AI | Immersive Canvas</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="NeuroNexus">
    
    <!-- Custom NeuroNexus Icon (SVG Base64) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzBmMTcyYSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTYwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzYjgyZjYiIHN0cm9rZS13aWR0aD0iMjAiIG9wYWNpdHk9IjAuNSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTIwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1kYXNoYXJyYXk9IjYwIDIwIi8+PHBhdGggZD0iTTI1NiAxNjB2MTkyTTM1MiAyNTZIMTYwIiBzdHJva2U9IiNkwDAwZmYiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iNDAiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzBmMTcyYSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTYwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzYjgyZjYiIHN0cm9rZS13aWR0aD0iMjAiIG9wYWNpdHk9IjAuNSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTIwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1kYXNoYXJyYXk9IjYwIDIwIi8+PHBhdGggZD0iTTI1NiAxNjB2MTkyTTM1MiAyNTZIMTYwIiBzdHJva2U9IiNkwDAwZmYiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iNDAiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=">

    <!-- Manifest Base64 CORRIGIDO (ID √önico + √çcones PNG Base64 para garantir instala√ß√£o) -->
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIk5ldXJvTmV4dXMgVWx0cmEiLAogICJzaG9ydF9uYW1lIjogIk5ldXJvTmV4dXMiLAogICJpZCI6ICI/?dj0zLjkiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzBmMTcyYSIsCiAgInRoZW1lX2NvbG9yIjogIiMwZjE3MmEiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdC1wcmltYXJ5IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1TE15NXZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c1SWpBd0lEQTFNVElnTlRFeU1pNDhjbVZqZENCM2FXUjBhRDB5TlRJaSBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzBmMTcyYSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTYwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzYjgyZjYiIHN0cm9rZS13aWR0aD0iMjAiIG9wYWNpdHk9IjAuNSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTIwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1kYXNoYXJyYXk9IjYwIDIwIi8+PHBhdGggZD0iTTI1NiAxNjB2MTkyTTM1MiAyNTZIMTYwIiBzdHJva2U9IiNkwDAwZmYiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iNDAiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4iLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRXVnQUFBTUFBQUFEQUNBWUFBQUJCdj91RkFBQUFBWE5TUjBJQXJzNGM2UUFBQURobEJFRUtDcjRBQ1hjQUFBQXFBRUJJQUFBQVpBQVFBQUFBQlFBQUFBQUFBQUFCMlprTkFBQUFGMWxXRFlYUk9ibTF0TTA1aFp3QUFBQUFCSlJVNUVJrS9naWkyQUFBKzFBQUFFWkJBTkhab0FBQVlDQUFBUVJBQUJuRkFBQUFBQUFBQ0daODh1RkFBQUFDbmtEVlFrak05L3Mvd0FBN0swdjF2N3c0K0FBQUFBRWxGVGtTdVFtQ0MiLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFdWdBQUFnQUFBQUlBQ0FZQUFBREdwWHA4QUFBQUFYTlNSMElBcnM0YzZRQUFBRGhsQkVFS0NyNEFDWGNBQUFBcUFFQklBQUFBWkFBUUFBQUFCUUFBQUFBQUFBQUFCMlprTkFBQUFGMWxXRFlYUk9ibTF0TTA1aFp3QUFBQUFCSlJVNUVJrS9naWkyQUFBKzFBQUFFWkJBTkhab0FBQVlDQUFBUVJBQUJuRkFBQUFBQUFBQ0daODh1RkFBQUFDbmtEVlFrak05L3Mvd0FBN0swdjF2N3c0K0FBQUFBRWxGVGtTdVFtQ0MiLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Pyodide for Local Python Execution (RESE) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Themes */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --code-bg: #0d1117;
            --terminal-bg: #1e1e1e;
            --terminal-text: #33ff00;
        }

        body.theme-neon {
            --bg-primary: #050505;
            --bg-secondary: #0a0a0a;
            --text-primary: #00ffcc;
            --text-secondary: #008f72;
            --accent: #d000ff;
            --accent-hover: #a100c4;
            --terminal-text: #00ffcc;
        }

        body.theme-light {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --code-bg: #f1f5f9;
            --terminal-bg: #f3f4f6;
            --terminal-text: #1f2937;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', system-ui, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden; 
            overscroll-behavior: none; /* Prevent pull-to-refresh on mobile */
        }

        .layout-container { 
            display: flex; 
            height: 100vh; 
            /* Fallback for mobile browsers */
            height: 100dvh; 
            width: 100vw; 
            overflow: hidden; 
        }

        /* Markdown Styles */
        .prose pre { background: var(--code-bg) !important; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; position: relative; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose code { font-family: 'Fira Code', monospace; font-size: 0.85em; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose img { max-width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .prose h1, .prose h2, .prose h3 { color: var(--text-primary); font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; }
        .prose ul, .prose ol { margin-left: 1.5rem; list-style-type: disc; margin-bottom: 0.75rem; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Canvas Animation */
        #main-chat-area { transition: width 0.3s ease, flex-grow 0.3s ease; }
        #canvas-panel { transition: width 0.3s ease, transform 0.3s ease; }

        /* Terminal Styles */
        .terminal-output {
            font-family: 'Fira Code', monospace;
            background-color: var(--terminal-bg);
            color: var(--terminal-text);
            padding: 10px;
            font-size: 0.80rem;
            height: 100%;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Chat Bubbles Optimization */
        .msg-bubble {
            max-width: 85%;
            padding: 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }

        @media (min-width: 768px) {
            .canvas-open #main-chat-area { width: 55%; flex-grow: 0; }
            .canvas-open #canvas-panel {
                width: 45%;
                transform: translateX(0) !important;
                border-left: 1px solid rgba(255,255,255,0.1);
                box-shadow: -10px 0 30px rgba(0,0,0,0.5);
                z-index: 20;
            }
            #canvas-panel { width: 0; overflow: hidden; }
            .msg-bubble { max-width: 75%; }
        }
        
        @media (max-width: 767px) {
            #canvas-panel {
                position: fixed; top: 0; right: 0; bottom: 0; width: 100%;
                transform: translateX(100%); z-index: 60; /* Higher Z-index for mobile overlap */
            }
            .canvas-open-mobile #canvas-panel { transform: translateX(0); }
            
            /* Mobile Optimization */
            .prose { font-size: 1rem; } /* Textos maiores no mobile */
            #user-input { font-size: 16px; /* Prevent iOS zoom */ }
            
            .msg-bubble { 
                max-width: 92%; /* Mais espa√ßo para texto no mobile */
                padding: 0.8rem;
            }
            
            /* Ajuste de margens do chat container */
            #chat-container { padding-left: 0.5rem; padding-right: 0.5rem; }
        }

        /* Loader */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
            background-color: var(--text-secondary);
            border-radius: 50%; display: inline-block; height: 6px; width: 6px; margin-right: 4px;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="">

    <div class="layout-container">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="flex-shrink-0 w-64 bg-[var(--bg-secondary)] border-r border-gray-700 flex flex-col z-50 transition-transform duration-300 absolute md:relative h-full -translate-x-full md:translate-x-0 shadow-2xl md:shadow-none">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <!-- Icon in Sidebar -->
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzBmMTcyYSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTYwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzYjgyZjYiIHN0cm9rZS13aWR0aD0iMjAiIG9wYWNpdHk9IjAuNSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTIwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1kYXNoYXJyYXk9IjYwIDIwIi8+PHBhdGggZD0iTTI1NiAxNjB2MTkyTTM1MiAyNTZIMTYwIiBzdHJva2U9IiNkwDAwZmYiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iNDAiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=" class="w-8 h-8 rounded-lg">
                    <div>
                        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">NeuroNexus</h1>
                        <p class="text-[10px] text-[var(--text-secondary)]">V3.9 | PWA Fixed ID</p>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400 p-2"><i class="fas fa-times fa-lg"></i></button>
            </div>

            <div class="p-4 border-b border-gray-700">
                <label class="text-[10px] uppercase text-[var(--text-secondary)] font-bold tracking-wider">Workflow Mode</label>
                <select id="workflow-mode" onchange="updateWorkflowMode()" class="w-full mt-1 bg-[var(--bg-primary)] text-[var(--text-primary)] text-xs border border-gray-600 rounded p-2 focus:outline-none focus:border-[var(--accent)]">
                    <option value="default">‚ö° Padr√£o (Full Stack)</option>
                    <option value="security">üîí Strict Security (OWASP)</option>
                    <option value="architect">üèõÔ∏è Software Architect</option>
                    <option value="db_opt">üóÑÔ∏è Otimiza√ß√£o SQL/NoSQL</option>
                    <option value="api_contract">üìú Contrato API (OpenAPI)</option>
                    <option value="iac">‚òÅÔ∏è Infra as Code (IaC)</option>
                    <option value="perf">üöÄ Performance & Algo</option>
                    <option value="a11y">‚ôø Acessibilidade (WCAG)</option>
                    <option value="docs">üìö Documenta√ß√£o Formal</option>
                    <option value="human_opt">üß¨ Otimiza√ß√£o Humana (Health)</option>
                </select>
            </div>

            <div class="flex-1 overflow-y-auto p-4 space-y-2" id="history-list">
                <!-- Install Button (Visible by default, logic handles click) -->
                <button id="install-btn" onclick="handleInstallClick()" class="hidden w-full text-left p-3 rounded-lg bg-green-600 text-white hover:bg-green-700 transition flex items-center gap-2 mb-2 shadow-lg border border-green-500">
                    <i class="fas fa-download"></i> <span id="install-text">Instalar App</span>
                </button>

                <div class="text-xs font-bold text-[var(--text-secondary)] uppercase tracking-wider mb-2">Mem√≥ria do Projeto</div>
                <!-- Dynamic Project Files List -->
                <div id="project-files-list" class="space-y-1 text-xs text-gray-400 font-mono">
                    <div class="italic p-2 text-center opacity-50">Nenhum arquivo no contexto.</div>
                </div>
                
                <div class="text-xs font-bold text-[var(--text-secondary)] uppercase tracking-wider mb-2 mt-4">Chats</div>
                <button onclick="newChat()" class="w-full text-left p-3 rounded-lg bg-[var(--accent)] text-white hover:opacity-90 transition flex items-center gap-2 active:scale-95 transform duration-150">
                    <i class="fas fa-plus"></i> Novo Chat
                </button>
                <div id="history-items-container" class="space-y-1 mt-2"></div>
            </div>

            <div class="p-4 border-t border-gray-700">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-2 h-2 rounded-full bg-yellow-500" id="python-status-dot"></div>
                    <span class="text-xs text-[var(--text-secondary)]" id="python-status-text">Carregando Pyodide...</span>
                </div>
                <button onclick="openSettings()" class="w-full p-3 rounded-lg bg-gray-700 hover:bg-gray-600 transition text-sm flex items-center justify-center gap-2 active:bg-gray-500">
                    <i class="fas fa-cog"></i> Configs & Chaves
                </button>
            </div>
        </aside>

        <!-- Install Instructions Modal -->
        <div id="install-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-[var(--bg-secondary)] rounded-2xl w-full max-w-sm shadow-2xl border border-gray-700 p-6 text-center">
                <div class="flex justify-center mb-4">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzBmMTcyYSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTYwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzYjgyZjYiIHN0cm9rZS13aWR0aD0iMjAiIG9wYWNpdHk9IjAuNSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTIwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1kYXNoYXJyYXk9IjYwIDIwIi8+PHBhdGggZD0iTTI1NiAxNjB2MTkyTTM1MiAyNTZIMTYwIiBzdHJva2U9IiNkwDAwZmYiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iNDAiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=" class="w-16 h-16 rounded-xl shadow-lg">
                </div>
                <h3 class="text-lg font-bold mb-2 text-white">Instalar NeuroNexus</h3>
                <p class="text-sm text-gray-300 mb-4">Para instalar como aplicativo:</p>
                <div class="text-left text-sm bg-gray-800 p-3 rounded-lg mb-4 space-y-2 border border-gray-700">
                    <p class="flex items-center gap-2"><i class="fas fa-share-square"></i> 1. Toque em <strong>Compartilhar</strong> (iOS) ou <strong>Menu</strong> (Android)</p>
                    <p class="flex items-center gap-2"><i class="fas fa-plus-square"></i> 2. Selecione <strong>Adicionar √† Tela de In√≠cio</strong></p>
                </div>
                <button onclick="document.getElementById('install-modal').classList.add('hidden')" class="w-full p-2 bg-[var(--accent)] text-white rounded-lg">Entendi</button>
            </div>
        </div>

        <!-- Overlay -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden backdrop-blur-sm"></div>

        <!-- Main Wrapper -->
        <div class="flex-1 flex relative overflow-hidden w-full">
            
            <!-- Chat Area -->
            <main id="main-chat-area" class="flex-1 flex flex-col h-full min-w-0 bg-[var(--bg-primary)]">
                
                <!-- Mobile Header -->
                <div class="md:hidden flex items-center justify-between p-4 glass-panel border-b border-gray-700 z-20 sticky top-0">
                    <div class="flex items-center gap-2">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzBmMTcyYSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTYwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzYjgyZjYiIHN0cm9rZS13aWR0aD0iMjAiIG9wYWNpdHk9IjAuNSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTIwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1kYXNoYXJyYXk9IjYwIDIwIi8+PHBhdGggZD0iTTI1NiAxNjB2MTkyTTM1MiAyNTZIMTYwIiBzdHJva2U9IiNkwDAwZmYiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iNDAiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=" class="w-6 h-6 rounded">
                        <h1 class="text-lg font-bold text-[var(--text-primary)]">NeuroNexus</h1>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="toggleCanvas()" id="mobile-canvas-btn" class="text-gray-300 active:text-white"><i class="fas fa-code fa-lg"></i></button>
                        <button onclick="toggleSidebar()" class="text-gray-300 active:text-white"><i class="fas fa-bars fa-lg"></i></button>
                    </div>
                </div>

                <!-- Messages -->
                <div id="chat-container" class="flex-1 overflow-y-auto p-2 md:p-8 space-y-6 scroll-smooth pb-32">
                    <div class="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-50" id="welcome-screen">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzBmMTcyYSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTYwIiBmaWxsPSJub25lIiBzdHJva2U9IiMzYjgyZjYiIHN0cm9rZS13aWR0aD0iMjAiIG9wYWNpdHk9IjAuNSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTIwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1kYXNoYXJyYXk9IjYwIDIwIi8+PHBhdGggZD0iTTI1NiAxNjB2MTkyTTM1MiAyNTZIMTYwIiBzdHJva2U9IiNkwDAwZmYiIHN0cm9rZS13aWR0aD0iMTUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iNDAiIGZpbGw9IiNmZmZmZmYiLz48L3N2Zz4=" class="w-24 h-24 mb-4 rounded-2xl shadow-2xl animate-pulse">
                        <h2 class="text-2xl font-bold">NeuroNexus V3.9</h2>
                        <p class="max-w-md text-sm px-4">Ambiente de Execu√ß√£o Real, An√°lise T√©cnica e Gest√£o de Contexto.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm w-full max-w-lg px-4">
                            <div class="p-3 border border-gray-700 rounded cursor-pointer hover:bg-[var(--bg-secondary)] active:bg-gray-700 transition" onclick="fillPrompt('Crie um script Python para an√°lise de dados e execute-o')">üêç Executar Python (RESE)</div>
                            <div class="p-3 border border-gray-700 rounded cursor-pointer hover:bg-[var(--bg-secondary)] active:bg-gray-700 transition" onclick="fillPrompt('Quais suplementos s√£o recomendados para programadores que trabalham √† noite?')">üíä Dicas Nutri√ß√£o (Devs)</div>
                            <div class="p-3 border border-gray-700 rounded cursor-pointer hover:bg-[var(--bg-secondary)] active:bg-gray-700 transition" onclick="fillPrompt('Gere um DDL para uma tabela de usu√°rios em PostgreSQL')">üóÑÔ∏è SQL Mode</div>
                            <div class="p-3 border border-gray-700 rounded cursor-pointer hover:bg-[var(--bg-secondary)] active:bg-gray-700 transition" onclick="fillPrompt('Desenhe um diagrama simples de rede neural em SVG')">üé® Criar Imagem (SVG)</div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-3 md:p-4 z-10 w-full">
                    <div class="max-w-4xl mx-auto glass-panel rounded-2xl p-2 shadow-lg flex flex-col gap-2 relative">
                        <div id="attachment-preview" class="hidden px-2 py-1 flex gap-2 overflow-x-auto"></div>
                        <div class="flex items-end gap-2 p-1">
                            <button onclick="document.getElementById('file-upload').click()" class="p-3 text-[var(--text-secondary)] hover:text-[var(--accent)] transition" title="Anexar (Logs, Imagens, Arquivos)">
                                <i class="fas fa-paperclip text-lg"></i>
                            </button>
                            <input type="file" id="file-upload" class="hidden" multiple accept="image/*,.pdf,.txt,.js,.py,.html,.css,.log,.json" onchange="handleFileUpload(this)">
                            
                            <textarea id="user-input" rows="1" class="flex-1 bg-transparent border-0 focus:ring-0 text-[var(--text-primary)] resize-none max-h-32 py-3 text-base" placeholder="Instru√ß√£o para o Co-piloto..." oninput="autoResize(this)" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                            
                            <button onclick="sendMessage()" class="p-3 bg-[var(--accent)] text-white rounded-xl hover:opacity-90 active:scale-95 transition shadow-lg w-12 h-12 flex items-center justify-center">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Canvas/Terminal Panel -->
            <div id="canvas-panel" class="bg-[var(--bg-secondary)] flex flex-col h-full shadow-2xl">
                <!-- Header -->
                <div class="flex items-center justify-between p-3 border-b border-gray-700 bg-[var(--bg-primary)]">
                    <div class="flex items-center gap-2">
                        <button onclick="toggleCanvas()" class="md:hidden text-gray-400 mr-2"><i class="fas fa-arrow-left"></i></button>
                        <i class="fas fa-layer-group text-[var(--accent)]"></i>
                        <span class="font-bold text-sm">Workspace</span>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="flex bg-gray-800 rounded p-1 gap-1">
                        <button onclick="switchTab('code')" id="tab-code" class="px-3 py-1 text-xs rounded bg-[var(--bg-secondary)] text-white shadow">Code</button>
                        <button onclick="switchTab('preview')" id="tab-preview" class="px-3 py-1 text-xs rounded text-gray-400 hover:text-white">Preview</button>
                        <button onclick="switchTab('terminal')" id="tab-terminal" class="px-3 py-1 text-xs rounded text-gray-400 hover:text-white flex items-center gap-1"><i class="fas fa-terminal"></i> RESE</button>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="executeCode()" id="btn-run-code" class="text-green-500 hover:text-green-400 hidden p-1" title="Executar Python"><i class="fas fa-play"></i></button>
                        <button onclick="copyCode()" class="text-gray-400 hover:text-white p-1" title="Copiar"><i class="far fa-copy"></i></button>
                        <button onclick="toggleCanvas()" class="text-gray-400 hover:text-white hidden md:block p-1"><i class="fas fa-times"></i></button>
                    </div>
                </div>

                <!-- Body -->
                <div class="flex-1 overflow-hidden relative">
                    <!-- Code View -->
                    <div id="view-code" class="absolute inset-0 overflow-auto p-4 bg-[#0d1117] h-full w-full">
                        <pre><code id="code-content" class="text-sm"></code></pre>
                    </div>
                    <!-- Preview View -->
                    <div id="view-preview" class="absolute inset-0 bg-white hidden h-full w-full">
                        <iframe id="preview-frame" class="w-full h-full border-0"></iframe>
                    </div>
                    <!-- Terminal View (RESE) -->
                    <div id="view-terminal" class="absolute inset-0 hidden h-full w-full flex flex-col">
                        <div class="bg-gray-800 px-2 py-1 text-xs text-gray-400 flex justify-between">
                            <span>Python 3.10 (Pyodide Wasm)</span>
                            <span onclick="clearTerminal()" class="cursor-pointer hover:text-white">Limpar</span>
                        </div>
                        <div id="terminal-output" class="terminal-output p-2">NeuroNexus Environment Initializing...</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[var(--bg-secondary)] rounded-2xl w-full max-w-lg shadow-2xl border border-gray-700 flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold">Configura√ß√µes</h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white p-2"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <!-- Keys Section -->
                <div>
                    <h3 class="font-semibold mb-2 text-[var(--accent)]"><i class="fas fa-key"></i> Chaves de API (Gemini)</h3>
                    <textarea id="api-keys-input" class="w-full h-24 bg-[var(--bg-primary)] border border-gray-600 rounded p-2 text-xs font-mono text-gray-300 focus:border-[var(--accent)] focus:outline-none" placeholder="Cole suas chaves API aqui..."></textarea>
                    
                    <h3 class="font-semibold mb-2 mt-4 text-green-500"><i class="fas fa-plug"></i> Integra√ß√µes (Opcional)</h3>
                    <p class="text-[10px] text-gray-400 mb-1">Armazenado localmente.</p>
                    <input type="text" id="github-key" class="w-full bg-[var(--bg-primary)] border border-gray-600 rounded p-2 text-xs mb-2 focus:border-[var(--accent)] focus:outline-none" placeholder="GitHub Token">
                    <input type="text" id="db-conn" class="w-full bg-[var(--bg-primary)] border border-gray-600 rounded p-2 text-xs focus:border-[var(--accent)] focus:outline-none" placeholder="String de Conex√£o DB">
                    
                    <div class="flex justify-between mt-4">
                        <button onclick="loadDefaultKeys()" class="text-xs text-[var(--accent)] hover:underline p-2">Restaurar Padr√£o</button>
                        <button onclick="saveKeys()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-xs">Salvar</button>
                    </div>
                </div>
                <!-- Appearance -->
                <div>
                    <h3 class="font-semibold mb-2 text-[var(--accent)]"><i class="fas fa-palette"></i> Tema</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setTheme('default')" class="p-2 border border-gray-600 rounded bg-[#0f172a] text-white text-xs">Padr√£o</button>
                        <button onclick="setTheme('neon')" class="p-2 border border-gray-600 rounded bg-black text-[#00ffcc] text-xs shadow-[0_0_10px_#00ffcc40]">Neon</button>
                        <button onclick="setTheme('light')" class="p-2 border border-gray-600 rounded bg-white text-black text-xs">Claro</button>
                    </div>
                </div>
                <div>
                    <button onclick="clearMemory()" class="w-full p-3 border border-red-500 text-red-500 rounded hover:bg-red-500 hover:text-white transition text-sm active:bg-red-600"><i class="fas fa-trash"></i> Limpar Mem√≥ria</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- 1. CORE UTILITIES (Hoisted: DEFINED FIRST) ---
        
        // Globals
        const DEFAULT_KEYS_OBFUSCATED = "QUl6YVN5QkxmTDlIQ1JUZjdNODUtSHJLV2pSSElkUC1vTFY0RGpjCkFJemFTeURPVVZpQ0wzWFlOaXNQZjRzYUpDTWdjQWxOeW50emx0dwpBSXphU3lCYjZyTEhwYmxIdkUxZGY4VU83anBJNlBmZzNyUmVMbzAKQUl6YVN5QXgwR0s2eVBuLUhFX3NZQWF1Rmd6X0J2MXBXQzR4SXhJCkFJemFTeUNVTi1QWDBjN1NhSnpNNUlKVWJWWmRPemlWdFVQb0FVMApBSXphU3lETXFvQkNqZjQ2RVo0WGhsdFNiZlJwNWZYeFFwRzRLZUEKQUl6YVN5QjEtLTlZQjRWOEFxbWpHYUFsbEUxZkwwMjA0MFZGaHZz";
        // REMOVED HARDCODED GITHUB KEY FOR SECURITY
        const DEFAULT_GITHUB_KEY = ""; 

        let apiKeys = [];
        let currentKeyIndex = 0;
        let chatHistory = [];
        let attachments = [];
        let currentCode = ""; 
        let currentLang = "";
        let pyodide = null;
        let projectFiles = {}; 
        let currentWorkflowMode = 'default';

        // --- PWA SERVICE WORKER REGISTRATION (FIX FOR PWA) ---
        // Since this is a single file, we register a Blob as the SW to bypass file requirement
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // FIXED SW: Claim clients immediately to make PWA installable faster
                const swCode = `
                    self.addEventListener('install', (e) => e.waitUntil(self.skipWaiting()));
                    self.addEventListener('activate', (e) => e.waitUntil(self.clients.claim()));
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(fetch(e.request));
                    });
                `;
                const blob = new Blob([swCode], {type: 'application/javascript'});
                const swUrl = URL.createObjectURL(blob);
                
                // PWA Fix: Explicitly log and try scope
                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('SW Registered for PWA:', reg))
                    .catch(err => console.log('SW Fail (Blob fallback):', err));
            });
        }

        // PWA Install Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('install-btn');
            if(installBtn) {
                installBtn.classList.remove('hidden');
            }
        });

        function handleInstallClick() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    document.getElementById('install-btn').classList.add('hidden');
                });
            } else {
                // Manual Instructions
                document.getElementById('install-modal').classList.remove('hidden');
            }
        }

        // --- Core UI Functions ---
        function renderProjectFiles() {
            const list = document.getElementById('project-files-list');
            if (!list) return;
            
            list.innerHTML = '';
            const files = Object.keys(projectFiles);
            if(files.length === 0) {
                list.innerHTML = '<div class="italic p-2 text-center opacity-50">Nenhum arquivo no contexto.</div>';
                return;
            }
            files.forEach(f => {
                const item = document.createElement('div');
                item.className = "p-1 hover:bg-gray-700 rounded cursor-pointer truncate flex items-center gap-2";
                item.innerHTML = `<i class="fas fa-file-code text-[var(--accent)]"></i> ${f}`;
                item.onclick = () => {
                    if(projectFiles[f]) {
                        currentCode = projectFiles[f];
                        // Detect lang based on extension
                        if (f.endsWith('.py')) currentLang = 'python';
                        else if (f.endsWith('.html')) currentLang = 'html';
                        else if (f.endsWith('.js')) currentLang = 'javascript';
                        else if (f.endsWith('.json')) currentLang = 'json';
                        else currentLang = 'plaintext';

                        const codeEl = document.getElementById('code-content');
                        if (codeEl) {
                            codeEl.className = `language-${currentLang}`;
                            codeEl.textContent = currentCode;
                            hljs.highlightElement(codeEl);
                        }
                        
                        switchTab('code');
                        forceOpenCanvas();
                        const runBtn = document.getElementById('btn-run-code');
                        if(currentLang === 'python' && runBtn) runBtn.classList.remove('hidden');
                    }
                };
                list.appendChild(item);
            });
        }

        function updateProjectContext(fileName, content) {
            projectFiles[fileName] = content;
            if (typeof renderProjectFiles === 'function') {
                renderProjectFiles();
            }
        }

        function updatePreviewIframe() {
            const frame = document.getElementById('preview-frame');
            if(!frame) return;
            const doc = frame.contentWindow.document;
            doc.open();
            
            if (currentLang === 'html') {
                doc.write(currentCode);
            } else if (currentLang === 'javascript') {
                // Tenta envelopar JS em HTML b√°sico para preview (√∫til para Chart.js)
                doc.write(`
                    <html><head><script src="https://cdn.tailwindcss.com"><\/script>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
                    </head><body class="p-4 bg-gray-50">
                    <div class="max-w-4xl mx-auto bg-white p-4 rounded shadow">
                        <canvas id="myChart"></canvas>
                        <div id="output"></div>
                    </div>
                    <script>
                        try { ${currentCode} } catch(e) { document.getElementById('output').innerText = e; }
                    <\/script>
                    </body></html>
                `);
            } else {
                doc.write(`<body style="background:#f4f4f5;font-family:monospace;padding:20px;color:#333;"><pre>${currentCode}</pre></body>`);
            }
            doc.close();
        }

        function switchTab(tab) {
            const views = {
                'code': document.getElementById('view-code'),
                'preview': document.getElementById('view-preview'),
                'terminal': document.getElementById('view-terminal')
            };
            const btns = {
                'code': document.getElementById('tab-code'),
                'preview': document.getElementById('tab-preview'),
                'terminal': document.getElementById('tab-terminal')
            };

            Object.values(views).forEach(v => v?.classList.add('hidden'));
            Object.values(btns).forEach(b => {
                b?.classList.remove('bg-[var(--bg-secondary)]', 'text-white', 'shadow');
                b?.classList.add('text-gray-400');
            });

            if(views[tab]) views[tab].classList.remove('hidden');
            if(btns[tab]) {
                btns[tab].classList.add('bg-[var(--bg-secondary)]', 'text-white', 'shadow');
                btns[tab].classList.remove('text-gray-400');
            }

            if (tab === 'preview') updatePreviewIframe();
        }

        function loadSettings() {
            const keys = localStorage.getItem('neuroNexusKeys');
            if (keys) apiKeys = JSON.parse(keys);
            else loadDefaultKeys();
            
            const keysInput = document.getElementById('api-keys-input');
            if(keysInput) keysInput.value = apiKeys.join('\n');
            
            let storedGithub = localStorage.getItem('neuroNexusGithub');
            // If stored key exists, use it. Otherwise default to empty.
            if (!storedGithub) {
                 storedGithub = "";
            }
            
            const ghInput = document.getElementById('github-key');
            if(ghInput) ghInput.value = storedGithub;
            
            const dbInput = document.getElementById('db-conn');
            if(dbInput) dbInput.value = localStorage.getItem('neuroNexusDB') || '';

            const theme = localStorage.getItem('neuroNexusTheme') || 'default';
            setTheme(theme);
            
            const mode = localStorage.getItem('neuroNexusWorkflow') || 'default';
            const wfSelect = document.getElementById('workflow-mode');
            if(wfSelect) {
                wfSelect.value = mode;
                currentWorkflowMode = mode;
            }
        }

        function loadDefaultKeys() {
            try {
                const keysInput = document.getElementById('api-keys-input');
                if(keysInput) keysInput.value = atob(DEFAULT_KEYS_OBFUSCATED);
                
                const ghInput = document.getElementById('github-key');
                if(ghInput) ghInput.value = ""; // Default empty
                saveKeys();
            } catch(e) {}
        }

        function saveKeys() {
            const keysInput = document.getElementById('api-keys-input');
            if(!keysInput) return;
            const raw = keysInput.value;
            apiKeys = raw.split('\n').map(k => k.trim()).filter(k => k.length > 10);
            localStorage.setItem('neuroNexusKeys', JSON.stringify(apiKeys));
            
            const ghInput = document.getElementById('github-key');
            if(ghInput) localStorage.setItem('neuroNexusGithub', ghInput.value);
            
            const dbInput = document.getElementById('db-conn');
            if(dbInput) localStorage.setItem('neuroNexusDB', dbInput.value);

            updateStatus("Online");
            closeSettings();
        }
        
        function updateWorkflowMode() {
            const wfSelect = document.getElementById('workflow-mode');
            if(wfSelect) {
                currentWorkflowMode = wfSelect.value;
                localStorage.setItem('neuroNexusWorkflow', currentWorkflowMode);
                // Opcional: Notificar no chat
                // addMessageToChat('model', `Modo de Workflow alterado para: **${wfSelect.options[wfSelect.selectedIndex].text}**. Ajustando foco.`);
            }
        }

        function updateStatus(txt) { 
            const el = document.getElementById('api-status-text');
            if(el) el.innerText = txt; 
        }
        
        function setTheme(name) {
            document.body.className = "theme-" + name;
            localStorage.setItem('neuroNexusTheme', name);
            // No mobile, remove a classe open para evitar glitch visual ao mudar tema
            if(window.innerWidth < 768) {
                 document.body.classList.remove('canvas-open-mobile');
            }
        }

        function renderHistory() { 
            const hist = document.getElementById('history-items-container');
            if(hist) hist.innerHTML = ''; 
        }

        function addMessageToChat(role, text, attachs = []) {
            const container = document.getElementById('chat-container');
            if(!container) return;
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            let attachHTML = '';
            if (attachs.length > 0) {
                attachHTML = `<div class="mb-2 flex gap-2 flex-wrap justify-end">${attachs.map(a => `<span class="text-xs bg-gray-700 px-2 py-1 rounded">üìé ${a.name || 'Anexo'}</span>`).join('')}</div>`;
            }

            let htmlContent = text;
            if (typeof marked !== 'undefined' && marked.parse) {
                try {
                    htmlContent = marked.parse(text);
                } catch (e) { console.error("Markdown parse error", e); }
            }

            // Mobile optimized bubbles using msg-bubble class
            div.innerHTML = `
                <div class="msg-bubble rounded-2xl ${role === 'user' ? 'bg-[var(--accent)] text-white rounded-br-none' : 'bg-[var(--bg-secondary)] border border-gray-700 rounded-bl-none'}">
                    ${attachHTML}
                    <div class="prose prose-invert text-sm md:text-base leading-relaxed break-words">${htmlContent}</div>
                </div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            if (typeof hljs !== 'undefined') {
                div.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
            }
        }

        function addLoader() {
            const c = document.getElementById('chat-container');
            if(!c) return;
            const id = 'l-' + Date.now();
            const d = document.createElement('div');
            d.id = id;
            d.className = "flex justify-start";
            d.innerHTML = `<div class="bg-[var(--bg-secondary)] border border-gray-700 rounded-2xl rounded-bl-none p-4"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            c.appendChild(d);
            c.scrollTop = c.scrollHeight;
            return id;
        }

        function removeLoader(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function forceOpenCanvas() {
             if (window.innerWidth < 768) {
                document.body.classList.add('canvas-open-mobile');
                const btn = document.getElementById('mobile-canvas-btn');
                if(btn) btn.classList.remove('hidden');
            } else {
                document.body.classList.add('canvas-open');
            }
        }

        // --- 2. PYTHON CODE STRINGS ---
        const MOA_SCHEDULER_CODE = `import asyncio
import time
import math
import os
import json
from typing import Dict, Callable, List, Any, Awaitable, Tuple
from dataclasses import dataclass, field

# --- MOA.Resilience ---
class MOAResilience:
    CHECKPOINT_DIR = "moa_checkpoints/"
    
    @staticmethod
    def create_checkpoint(task_id: str, state_data: dict) -> str:
        if not os.path.exists(MOAResilience.CHECKPOINT_DIR):
            os.makedirs(MOAResilience.CHECKPOINT_DIR)
        
        filepath = f"{MOAResilience.CHECKPOINT_DIR}{task_id}_checkpoint.json"
        with open(filepath, 'w') as f:
            json.dump(state_data, f)
        print(f"[MOA.Resilience] Checkpoint criado para {task_id}")
        return filepath

    @staticmethod
    def rollback(task_id: str):
        filepath = f"{MOAResilience.CHECKPOINT_DIR}{task_id}_checkpoint.json"
        if os.path.exists(filepath):
            print(f"[MOA.Resilience] üî¥ INICIANDO ROLLBACK PARA {task_id}...")
            with open(filepath, 'r') as f:
                state = json.load(f)
            print(f"[MOA.Resilience] ‚úÖ Estado restaurado: {state}")
            return state
        else:
            print(f"[MOA.Resilience] ERRO: Checkpoint n√£o encontrado.")
            return None

# --- MOA.Flow ---
@dataclass
class MOATask:
    name: str
    func: Callable[..., Awaitable[Any]] 
    deps: List[str] = field(default_factory=list) 
    args: List[Any] = field(default_factory=list)
    complexity: int = 5 
    model: str = "gpt-4o"
    result: Any = None
    status: str = "PENDING"
    e_score: float = 0.0

class MOAFlowScheduler:
    def __init__(self):
        self.tasks: Dict[str, MOATask] = {}
        self.results: Dict[str, Any] = {}
        self.pending_tasks: set = set()
        self.executing_tasks: set = set()
        self.completed_tasks: set = set()

    def predict_T_and_C(self, prompt_tokens: int, max_output_tokens: int, model_name: str = "gpt-4o") -> Tuple[float, float]:
        COST_PER_INPUT_K_TOKENS = { "gpt-4o": 5.00 / 1_000_000, "gemini-flash": 0.35 / 1_000_000 }
        input_cost = prompt_tokens * COST_PER_INPUT_K_TOKENS.get(model_name, 5.00 / 1_000_000)
        output_cost = max_output_tokens * (COST_PER_INPUT_K_TOKENS.get(model_name, 5.00 / 1_000_000) * 2)
        C = input_cost + output_cost
        speed_factor = 1.0 if model_name == "gpt-4o" else 1.5 
        T = (prompt_tokens + max_output_tokens) / (1000 * speed_factor)
        return T, C

    async def calculate_E_score(self, task: MOATask) -> float:
        prompt_tokens = task.complexity * 200
        max_output_tokens = task.complexity * 100
        T, C = self.predict_T_and_C(prompt_tokens, max_output_tokens, task.model)
        Q = 10.0 if task.model == 'gpt-4o' else 8.0 
        T_adjusted = max(0.01, T)
        e_score = Q / (math.log(T_adjusted + 1) + (C * 100))
        return e_score

    def decide_action(self, e_score: float) -> str:
        """[MOA.Decide] Determina a a√ß√£o com base no E-Score."""
        if e_score >= 0.8: return "EXECUTE_FLOW"
        elif e_score >= 0.5: return "OPTIMIZE_PARAMETERS"
        else: return "ANALYZE_FALLBACK"

    def add_task(self, task: MOATask):
        if task.name in self.tasks: raise ValueError(f"Tarefa '{task.name}' j√° existe.")
        self.tasks[task.name] = task
        self.pending_tasks.add(task.name)

    async def _execute_task(self, task_name: str):
        task = self.tasks[task_name]
        resolved_args = list(task.args)
        
        # MOA.Resilience: Snapshot before execution
        MOAResilience.create_checkpoint(task_name, {"status": "PENDING", "timestamp": time.time()})

        for dep_name in task.deps:
            if dep_name in self.results: resolved_args.append(self.results[dep_name])
            else: raise RuntimeError(f"Depend√™ncia '{dep_name}' falhou.")

        task.e_score = await self.calculate_E_score(task)
        action = self.decide_action(task.e_score)
        
        print(f"[MOA.Decide] {task_name}: E-Score={task.e_score:.2f} -> {action}")
        
        if action == "ANALYZE_FALLBACK":
            print(f"[MOA.Flow] Pausando {task_name} por baixo score.")
            return

        task.status = "RUNNING"
        print(f"[MOA.Flow] Executando: {task_name}...")
        try:
            task.result = await task.func(*resolved_args)
            self.results[task_name] = task.result
            task.status = "COMPLETED"
            print(f"[MOA.Flow] Conclu√≠do: {task_name}.")
        except Exception as e:
            task.status = "FAILED"
            print(f"[MOA.Flow] FALHA em {task_name}: {e}")
            # MOA.Resilience: Rollback Trigger
            MOAResilience.rollback(task_name)
            raise

    def _get_ready_tasks(self) -> List[str]:
        ready = []
        for name in self.pending_tasks:
            task = self.tasks[name]
            if all(dep in self.completed_tasks for dep in task.deps): ready.append(name)
        return ready

    async def execute_flow(self):
        print("--- INICIANDO MOA.FLOW (FULL STACK) ---")
        while self.pending_tasks or self.executing_tasks:
            ready_to_run = self._get_ready_tasks()
            if not ready_to_run and self.pending_tasks and not self.executing_tasks:
                print("[MOA.Flow] ERRO: Deadlock detectado.")
                break
            new_tasks = []
            for task_name in ready_to_run:
                self.pending_tasks.remove(task_name)
                self.executing_tasks.add(task_name)
                new_tasks.append(self._execute_task(task_name))
            if new_tasks:
                done, pending = await asyncio.wait(new_tasks, return_when=asyncio.FIRST_COMPLETED)
                for future in done:
                    try:
                        await future
                        for name in list(self.executing_tasks):
                            if self.tasks[name].status == "COMPLETED":
                                self.executing_tasks.remove(name)
                                self.completed_tasks.add(name)
                            elif self.tasks[name].status == "FAILED": return
                    except Exception as e:
                        print(f"[MOA.Flow] ERRO FATAL: {e}")
                        return
            await asyncio.sleep(0.01)
        print("--- MOA.FLOW CONCLU√çDO ---")
        return self.results
`;

        const TEST_MOA_FLOW_CODE = `import asyncio
from moa_flow_scheduler import MOATask, MOAFlowScheduler

async def task_fetch_data(source: str):
    await asyncio.sleep(0.2)
    return {"data": f"Dados de {source}", "count": 100}

async def task_fail_simulation(data: str):
    await asyncio.sleep(0.5)
    raise ValueError("Falha Simulada para Teste de Rollback")

async def main_test():
    scheduler = MOAFlowScheduler()
    t1 = MOATask(name="T1_Fetch", func=task_fetch_data, args=["DB_Alpha"], complexity=2)
    t2 = MOATask(name="T2_Fail", func=task_fail_simulation, deps=["T1_Fetch"], complexity=8)
    
    scheduler.add_task(t1)
    scheduler.add_task(t2)
    
    print("--- INICIANDO TESTE COM FALHA SIMULADA ---")
    try:
        scheduler.execute_flow()
    except Exception:
        print("--- TESTE CONCLU√çDO: Falha Capturada Corretamente ---")

# ASYNCIO FIX FOR PYODIDE ENV
if __name__ == "__main__":
    try:
        loop = asyncio.get_running_loop()
    except RuntimeError:
        loop = None

    if loop and loop.is_running():
        # Web Environment (Already has loop)
        await main_test()
    else:
        # Local Environment
        asyncio.run(main_test())
`;

        // --- NEW MEMORY MODULE CODE (SIMULATED RAG) ---
        const MOA_MEMORY_CODE = `import json
import os
import time
from typing import List, Dict
from difflib import SequenceMatcher

# Simula√ß√£o de RAG (Retrieval-Augmented Generation) para Ambiente Browser (Pyodide)
# Em produ√ß√£o, usar√≠amos ChromaDB + SentenceTransformers.
# Aqui usamos 'difflib' para similaridade de string para demonstrar o conceito sem depend√™ncias pesadas.

class ProjectMemory:
    def __init__(self, project_name="NeuroNexus_Project"):
        self.memory_file = f"{project_name}_memory.json"
        self.memories = []
        self.load_memory()

    def load_memory(self):
        if os.path.exists(self.memory_file):
            try:
                with open(self.memory_file, 'r') as f:
                    self.memories = json.load(f)
            except:
                self.memories = []
        else:
            self.memories = []

    def _calculate_similarity(self, a, b):
        return SequenceMatcher(None, a, b).ratio()

    def store_conversation(self, interaction_id: str, text_content: str, tags: List[str] = None):
        """Armazena um novo fragmento de conhecimento."""
        entry = {
            "id": interaction_id,
            "content": text_content,
            "tags": tags or [],
            "timestamp": time.time()
        }
        self.memories.append(entry)
        self._save_memory()
        print(f"[ProjectMemory] Indexado ID: {interaction_id}")

    def _save_memory(self):
        with open(self.memory_file, 'w') as f:
            json.dump(self.memories, f)

    def retrieve_context(self, user_query: str, k=3):
        """Recupera contexto relevante baseado em similaridade."""
        print(f"[ProjectMemory] Buscando contexto para: '{user_query}'...")
        
        if not self.memories:
            return "Nenhuma mem√≥ria armazenada ainda."

        scored_memories = []
        for mem in self.memories:
            # Score simples baseado em similaridade de texto + match de tags
            score = self._calculate_similarity(user_query.lower(), mem['content'].lower())
            scored_memories.append((score, mem))
        
        # Ordena por relev√¢ncia
        scored_memories.sort(key=lambda x: x[0], reverse=True)
        
        # Filtra top K com threshold m√≠nimo
        top_k = [m[1]['content'] for m in scored_memories[:k] if m[0] > 0.1]
        
        if not top_k:
            return "Nenhum contexto relevante encontrado na mem√≥ria com score suficiente."
        
        return "\\n--- CONTEXTO RECUPERADO ---\\n".join(top_k)

# Inst√¢ncia Global para uso no terminal
memory_system = ProjectMemory()
print("[ProjectMemory] Sistema de Mem√≥ria RAG (Simulado) Inicializado.")
`;

        const GAP_ANALYSIS_STRATEGY = `
STATUS: NEURONEXUS V3.9 (PWA FIXED ID).
O Manifesto inclui um ID √∫nico com query string.
Os √≠cones s√£o PNGs Base64 embutidos.

A√á√ÉO RECOMENDADA: O sistema agora deve ser tratado como uma nova instala√ß√£o PWA.
        `;

        // --- 4. EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            renderHistory();
            initPyodide();
            if (typeof marked !== 'undefined') {
                marked.setOptions({
                    highlight: function(code, lang) {
                        if (typeof hljs === 'undefined') return code;
                        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                        return hljs.highlight(code, { language }).value;
                    }
                });
            }
        });

        // --- 5. LOGIC & API ---
        async function initPyodide() {
            const terminal = document.getElementById('terminal-output');
            const statusDot = document.getElementById('python-status-dot');
            const statusText = document.getElementById('python-status-text');

            try {
                if (terminal) {
                    terminal.innerText = "NeuroNexus OS v3.9 Booting...\n";
                    terminal.innerText += "> Loading MOA Modules... OK\n";
                    terminal.innerText += "> Initializing Pyodide WASM Kernel...\n";
                }

                if (typeof loadPyodide === 'undefined') throw new Error("Pyodide not loaded");

                pyodide = await loadPyodide();
                await pyodide.loadPackage("micropip"); 
                
                pyodide.FS.writeFile("moa_flow_scheduler.py", MOA_SCHEDULER_CODE);
                pyodide.FS.writeFile("test_moa_flow.py", TEST_MOA_FLOW_CODE);
                pyodide.FS.writeFile("moa_memory.py", MOA_MEMORY_CODE); // Loading Memory Module

                updateProjectContext('moa_flow_scheduler.py', MOA_SCHEDULER_CODE);
                updateProjectContext('test_moa_flow.py', TEST_MOA_FLOW_CODE);
                updateProjectContext('moa_memory.py', MOA_MEMORY_CODE);
                
                // Auto-run memory init
                await pyodide.runPythonAsync(MOA_MEMORY_CODE);

                if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-green-500";
                if (statusText) statusText.innerText = "Python Ready (RESE)";
                
                if (terminal) {
                    terminal.innerText += "> Python Kernel Ready.\n";
                    terminal.innerText += "> MOA Full Stack: LOADED.\n";
                    terminal.innerText += "> RAG Memory System: ONLINE.\n";
                    terminal.innerText += "> System Ready.\n";
                }
                
                console.log("Pyodide Ready");
            } catch (e) {
                console.error("Pyodide failed", e);
                if (statusText) statusText.innerText = "Python Failed";
                if (statusDot) statusDot.className = "w-2 h-2 rounded-full bg-red-500";
                if (terminal) terminal.innerText += `\n[BOOT ERROR]: ${e.message}\n`;
            }
        }

        async function executeCode() {
            if (currentLang !== 'python') {
                alert("A execu√ß√£o em tempo real est√° configurada para Python no momento. Para JS/HTML, use a aba 'Preview'.");
                return;
            }
            if (!pyodide) {
                alert("O ambiente Python ainda est√° carregando. Aguarde...");
                return;
            }

            switchTab('terminal');
            const terminal = document.getElementById('terminal-output');
            if(terminal) terminal.innerText += `\n> Executando script...\n`;

            try {
                pyodide.setStdout({ batched: (msg) => { 
                    if(terminal) terminal.innerText += msg + "\n"; 
                } });
                await pyodide.runPythonAsync(currentCode);
                if(terminal) terminal.innerText += `\n[Processo finalizado com sucesso]\n`;
            } catch (err) {
                if(terminal) terminal.innerText += `\nERRO DE EXECU√á√ÉO:\n${err}\n`;
            }
            if(terminal) terminal.scrollTop = terminal.scrollHeight;
        }

        function clearTerminal() {
            const term = document.getElementById('terminal-output');
            if (term) term.innerText = "NeuroNexus Environment Initialized...";
        }

        function getNextKey() {
            if (apiKeys.length === 0) return null;
            return apiKeys[currentKeyIndex];
        }

        function rotateKey() {
            currentKeyIndex = (currentKeyIndex + 1) % apiKeys.length;
            updateStatus(`Rotacionando API (${currentKeyIndex + 1}/${apiKeys.length})`);
        }

        async function callGemini(userMessage, files = []) {
            let attempts = 0;
            const maxAttempts = (apiKeys.length > 0) ? apiKeys.length : 1;

            while (attempts < maxAttempts) {
                let key = getNextKey();
                
                if (!key) {
                    loadSettings();
                    key = getNextKey();
                    if (!key) {
                        alert("ERRO CR√çTICO: Nenhuma chave API configurada. Por favor, v√° em Configura√ß√µes e clique em 'Restaurar Padr√£o'.");
                        throw new Error("Sem chaves configuradas.");
                    }
                }

                const model = document.getElementById('model-select')?.value || 'gemini-2.5-flash-preview-09-2025';
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

                const newContent = { role: "user", parts: [{ text: userMessage }] };
                if (files.length > 0) {
                    files.forEach(f => newContent.parts.push({ inlineData: { mimeType: f.mimeType, data: f.data } }));
                }

                const fileContext = JSON.stringify(Object.keys(projectFiles));
                const githubKey = localStorage.getItem('neuroNexusGithub') || "N√£o configurado";
                
                // --- DYNAMIC MODE INSTRUCTION ---
                let modeInstruction = "Modo: Padr√£o (Full Stack Senior).";
                switch(currentWorkflowMode) {
                    case 'security': modeInstruction = "MODO: Strict Security (OWASP). Valide tudo."; break;
                    case 'architect': modeInstruction = "MODO: Arquiteto de Software. Foco em padr√µes, escalabilidade e trade-offs."; break;
                    case 'db_opt': modeInstruction = "MODO: Otimiza√ß√£o de Banco de Dados. Gere DDLs, use EXPLAIN, sugira √≠ndices."; break;
                    case 'api_contract': modeInstruction = "MODO: Contrato de API. Gere OpenAPI/Swagger specs."; break;
                    case 'iac': modeInstruction = "MODO: Infra as Code. Gere Terraform, Dockerfiles, K8s manifests."; break;
                    case 'perf': modeInstruction = "MODO: Performance. Analise Big O, sugira otimiza√ß√µes de loops e mem√≥ria."; break;
                    case 'a11y': modeInstruction = "MODO: Acessibilidade. Verifique WCAG, ARIA e contrastes."; break;
                    case 'docs': modeInstruction = "MODO: Documenta√ß√£o. Gere JSDoc, Docstrings e READMEs formais."; break;
                    case 'human_opt': modeInstruction = "MODO: Performance Humana (Health). D√™ dicas de nutri√ß√£o e sono para alta performance profissional. SEMPRE inclua o disclaimer de n√£o ser m√©dico."; break;
                }

                
                // --- FIXED SYSTEM PROMPT: TEACHING AI TO USE TOOLS ---
                const systemPromptText = `
System: Voc√™ √© NeuroNexus V3.9, uma IA Full Stack Senior, Gerente de Projetos e Especialista em Mem√≥ria RAG.

=== SUAS CAPACIDADES T√âCNICAS ===
1. **Python (RESE):** Gere e rode Python. Use 'moa_memory.py' para persistir dados importantes.
   - Para salvar algo na mem√≥ria: "Use memory_system.store_conversation('id', 'texto')".
   - Para lembrar algo: "Use memory_system.retrieve_context('tema')".
2. **Gr√°ficos (Chart.js):** Gere c√≥digo HTML completo com Chart.js.
3. **PDFs (jsPDF):** Gere c√≥digo JS para PDFs.
4. **Imagens/Diagramas:** Gere SVG Inline.
5. **Consultoria Humana:** D√™ dicas de sa√∫de e nutri√ß√£o para profissionais, mas sempre com disclaimer m√©dico.

=== CONTEXTO ATUAL ===
Arquivos na mem√≥ria: ${fileContext}
${modeInstruction}

Se o usu√°rio for casual, seja casual. Se for t√©cnico, seja preciso. Se houver erro no c√≥digo do usu√°rio, aponte e corrija.
                `;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: systemPromptText }] }, ...chatHistory, newContent],
                    generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
                };

                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.status === 429) { rotateKey(); attempts++; continue; }
                    if (!response.ok) throw new Error(await response.text());
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    if (attempts === maxAttempts - 1) throw error;
                    rotateKey();
                    attempts++;
                }
            }
        }

        async function sendMessage() {
            const inputEl = document.getElementById('user-input');
            const msg = inputEl.value.trim();
            if (!msg && attachments.length === 0) return;

            const welcome = document.getElementById('welcome-screen');
            if(welcome) welcome.style.display = 'none';
            
            inputEl.value = '';
            inputEl.style.height = 'auto';

            addMessageToChat('user', msg, attachments);

            const currentAttachments = [...attachments];
            chatHistory.push({
                role: "user",
                parts: [{ text: msg }, ...currentAttachments.map(a => ({ inlineData: { mimeType: a.mimeType, data: a.data } }))]
            });
            
            attachments = [];
            const attachPrev = document.getElementById('attachment-preview');
            if(attachPrev) {
                attachPrev.innerHTML = '';
                attachPrev.classList.add('hidden');
            }

            const loaderId = addLoader();

            try {
                const responseText = await callGemini(msg, currentAttachments);
                removeLoader(loaderId);
                chatHistory.push({ role: "model", parts: [{ text: responseText }] });
                addMessageToChat('model', responseText);
                
                processArtifacts(responseText);

            } catch (error) {
                removeLoader(loaderId);
                addMessageToChat('model', `‚ö†Ô∏è **Erro:** ${error.message}`);
            }
        }

        function processArtifacts(text) {
            const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
            let match;
            let lastCode = null;
            let lastLang = null;

            while ((match = codeBlockRegex.exec(text)) !== null) {
                const lang = (match[1] || 'text').toLowerCase();
                const code = match[2];
                // Update Project Memory
                if (lang !== 'text' && lang !== 'bash') {
                    // Try to guess a name if not provided (simple logic)
                    let fakeName = `artifact_${Date.now()}.${lang === 'python' ? 'py' : lang === 'javascript' ? 'js' : lang}`;
                    updateProjectContext(fakeName, code);
                }

                if (lang === 'html' || lang === 'python' || lang === 'javascript' || lang === 'json' || !lastCode) {
                    lastLang = lang;
                    lastCode = code;
                }
            }

            if (lastCode) {
                currentCode = lastCode;
                currentLang = lastLang;
                
                const codeEl = document.getElementById('code-content');
                if (codeEl) {
                    codeEl.className = `language-${currentLang}`;
                    codeEl.textContent = currentCode;
                    hljs.highlightElement(codeEl);
                }

                forceOpenCanvas();

                // Logic for Tab Switching based on Lang
                const runBtn = document.getElementById('btn-run-code');
                if (currentLang === 'python') {
                    switchTab('code'); // Show code first
                    if(runBtn) runBtn.classList.remove('hidden'); // Show Run button
                } else if (currentLang === 'html' || currentLang === 'javascript') {
                    // Se for JS ou HTML, provavel ser visual (grafico/svg), mostrar preview
                    switchTab('preview');
                    if(runBtn) runBtn.classList.add('hidden');
                } else {
                    switchTab('code');
                    if(runBtn) runBtn.classList.add('hidden');
                }
            }
        }

        const WELCOME_CONTENT = `
            <div class="flex flex-col items-center justify-center h-full text-center space-y-4 opacity-50" id="welcome-screen">
                <i class="fas fa-network-wired text-6xl text-[var(--accent)] mb-4"></i>
                <h2 class="text-2xl font-bold">NeuroNexus Project Manager</h2>
                <p class="max-w-md">Ambiente de Execu√ß√£o Real, An√°lise T√©cnica e Gest√£o de Contexto.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm w-full max-w-lg">
                    <div class="p-3 border border-gray-700 rounded cursor-pointer hover:bg-[var(--bg-secondary)]" onclick="fillPrompt('Crie um script Python para an√°lise de dados e execute-o')">üêç Executar Python (RESE)</div>
                    <div class="p-3 border border-gray-700 rounded cursor-pointer hover:bg-[var(--bg-secondary)]" onclick="fillPrompt('Use o moa_memory.py para salvar este chat na mem√≥ria permanente')">üß† Testar Mem√≥ria (RAG)</div>
                </div>
            </div>
        `;

        function newChat() {
            chatHistory = [];
            projectFiles = {};
            renderProjectFiles();
            const chatC = document.getElementById('chat-container');
            if(chatC) chatC.innerHTML = WELCOME_CONTENT;
            document.body.classList.remove('canvas-open', 'canvas-open-mobile');
            attachments = [];
            const attachPrev = document.getElementById('attachment-preview');
            if(attachPrev) {
                attachPrev.innerHTML = '';
                attachPrev.classList.add('hidden');
            }
        }

        function clearMemory() { if(confirm("Limpar?")) { newChat(); alert("Limpo."); } }
        function fillPrompt(txt) { const el = document.getElementById('user-input'); if(el) { el.value = txt; el.focus(); } }
        function openSettings() { document.getElementById('settings-modal')?.classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal')?.classList.add('hidden'); }
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        
        function handleFileUpload(input) {
            const files = Array.from(input.files);
            const prev = document.getElementById('attachment-preview');
            if(prev) prev.classList.remove('hidden');
            files.forEach(file => {
                const r = new FileReader();
                r.onload = (e) => {
                    attachments.push({ mimeType: file.type, data: e.target.result.split(',')[1], name: file.name });
                    const d = document.createElement('div');
                    d.innerHTML = `<div class="w-12 h-12 bg-gray-700 flex items-center justify-center border border-gray-600 rounded text-[10px] overflow-hidden p-1 text-center break-all">${file.name}</div>`;
                    if(prev) prev.appendChild(d);
                };
                r.readAsDataURL(file);
            });
            input.value = '';
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            if(sb) sb.classList.toggle('-translate-x-full');
            const ov = document.getElementById('sidebar-overlay');
            if(ov) ov.classList.toggle('hidden');
        }

        function toggleCanvas() {
            const body = document.body;
            const isOpen = body.classList.contains('canvas-open') || body.classList.contains('canvas-open-mobile');
            if (isOpen) {
                body.classList.remove('canvas-open', 'canvas-open-mobile');
            } else {
                if (window.innerWidth < 768) body.classList.add('canvas-open-mobile');
                else body.classList.add('canvas-open');
            }
        }

        function copyCode() {
            if (!currentCode) return;
            const textArea = document.createElement("textarea");
            textArea.value = currentCode;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                alert("C√≥digo copiado!");
            } catch (err) {
                console.error('Erro ao copiar', err);
                alert("Erro ao copiar c√≥digo. Permiss√£o negada.");
            }
            document.body.removeChild(textArea);
        }
    </script>
</body>
</html>
